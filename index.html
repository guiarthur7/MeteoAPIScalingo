<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CinéList</title>
    <link rel="stylesheet" href="./src/style.css">
</head>

<body>
    <header>
        <img src="./src/logo.png" alt="Logo">
        <span>CinéList</span>
        <div id="user-info" style="margin-left: auto; display: flex; gap: 10px; align-items: center;"></div>
    </header>

    <div class="search">
        <form id="searchForm">
            <input type="text" id="search" name="search" placeholder="Rechercher...">
            <button type="submit">Valider</button>
        </form>
    </div>

    <div id="movies"></div>

    <script>
        // Vérifier si l'utilisateur est connecté
        const user = JSON.parse(localStorage.getItem('user') || 'null');
        const userInfo = document.getElementById('user-info');

        if (user) {
            userInfo.innerHTML = `
                <span style="color: white;">Bonjour ${user.name} !</span>
                <button onclick="logout()" style="padding: 5px 15px; cursor: pointer; background: white; border: none; border-radius: 5px;">Déconnexion</button>
            `;
        } else {
            userInfo.innerHTML = `
                <a href="/login" style="color: white; text-decoration: none; padding: 5px 15px; background: rgba(255,255,255,0.2); border-radius: 5px;">Connexion</a>
            `;
        }

        function logout() {
            localStorage.removeItem('user');
            window.location.reload();
        }

        let allMovies = [];
        function displayMovies(movies) {
            const container = document.getElementById('movies');
            container.innerHTML = '';

            movies.forEach(movie => {
                if (!movie.Poster || movie.Poster === 'N/A' || !movie.Poster.startsWith('http')) {
                    return;
                }

                const div = document.createElement('div');
                div.className = 'movie-card';
                div.innerHTML = `
                    <img src="${movie.Poster}" 
                         alt="${movie.Title}" 
                         class="movie-poster"
                         onerror="this.parentElement.style.display='none'">
                    <div class="movie-title">${movie.Title}</div>
                    <div class="movie-year">${movie.Year}</div>
                `;
                container.appendChild(div);
            });
        }

        document.getElementById('searchForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const searchValue = document.getElementById('search').value;

            if (searchValue.trim() === '') {
                displayMovies(allMovies);
            } else {
                const filtered = allMovies.filter(movie =>
                    movie.Title.toLowerCase().includes(searchValue.toLowerCase())
                );
                displayMovies(filtered);
            }
        });

        fetch('/api/movies')
            // ÉTAPE 1 : fetch retourne une Promise avec l'objet response
            .then(response => response.json())
            // response.json() RETOURNE les données JSON

            // ÉTAPE 2 : les données JSON deviennent "movies"
            .then(movies => {           // movies = résultat de response.json()
                allMovies = movies
                displayMovies(movies);
            });
    </script>
</body>

</html>