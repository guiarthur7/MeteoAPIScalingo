<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cin√©List</title>
    <link rel="stylesheet" href="./src/style.css">
</head>

<body>
    <header>
        <img src="./src/logo.png" alt="Logo">
        <span>Cin√©List</span>
        <div id="user-info" style="margin-left: auto; color: white; display: flex; gap: 15px; align-items: center;">
            <span id="username"></span>
            <button onclick="logout()"
                style="padding: 8px 15px; cursor: pointer; background: white; color: #667eea; border: none; border-radius: 5px; font-weight: bold;">D√©connexion</button>
        </div>
    </header>

    <div style="max-width: 1400px; margin: 20px auto; padding: 0 20px;">
        <div style="display: flex; gap: 15px; margin-bottom: 20px;">
            <button id="allMoviesTab" onclick="showAllMovies()"
                style="padding: 10px 20px; cursor: pointer; background: #667eea; color: white; border: none; border-radius: 5px; font-weight: bold;">Tous
                les films</button>
            <button id="likedMoviesTab" onclick="showLikedMovies()"
                style="padding: 10px 20px; cursor: pointer; background: #2a2a2a; color: white; border: none; border-radius: 5px; font-weight: bold;">Mes
                films lik√©s</button>
        </div>
    </div>

    <div class="search">
        <form id="searchForm">
            <input type="text" id="search" name="search" placeholder="Rechercher...">
            <button type="submit">Valider</button>
        </form>
    </div>

    <div id="movies"></div>

    <script>
        const user = JSON.parse(localStorage.getItem('user') || 'null');

        if (!user || !user.username) {
            localStorage.removeItem('user');
            window.location.href = '/register';
        }

        function logout() {
            localStorage.removeItem('user');
            window.location.href = '/register';
        }

        if (user && user.username) {
            window.addEventListener('DOMContentLoaded', () => {
                document.getElementById('username').textContent = `Bonjour ${user.username} !`;
            });
        }

        let allMovies = [];
        let likedMovies = [];
        let currentView = 'all';

        async function toggleLike(movieId, movieTitle, moviePoster, movieYear) {
            console.log('Toggle like:', { movieId, userId: user.id });

            if (!user.id) {
                alert('Erreur: utilisateur non connect√© correctement. Reconnectez-vous.');
                return;
            }

            const isLiked = likedMovies.some(m => m.movie_id === movieId);

            try {
                if (isLiked) {
                    const response = await fetch(`/api/likes/${user.id}/${movieId}`, { method: 'DELETE' });
                    const data = await response.json();
                    console.log('Unlike response:', data);
                    if (data.success) {
                        likedMovies = likedMovies.filter(m => m.movie_id !== movieId);
                        if (currentView === 'all') {
                            displayMovies(allMovies);
                        } else {
                            displayLikedMovies();
                        }
                    }
                } else {
                    const response = await fetch('/api/likes', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            userId: user.id,
                            movieId: movieId,
                            movieTitle: movieTitle,
                            moviePoster: moviePoster,
                            movieYear: movieYear
                        })
                    });
                    const data = await response.json();
                    console.log('Like response:', data);
                    if (data.success) {
                        likedMovies.push({ movie_id: movieId, movie_title: movieTitle, movie_poster: moviePoster, movie_year: movieYear });
                        displayMovies(allMovies);
                    } else {
                        alert('Erreur: ' + (data.message || 'Impossible de liker'));
                    }
                }
            } catch (error) {
                console.error('Erreur toggleLike:', error);
                alert('Erreur de connexion au serveur');
            }
        }

        function displayMovies(movies) {
            const container = document.getElementById('movies');
            container.innerHTML = '';

            movies.forEach(movie => {
                if (!movie.Poster || movie.Poster === 'N/A' || !movie.Poster.startsWith('http')) {
                    return;
                }

                const isLiked = likedMovies.some(m => m.movie_id === movie.imdbID);
                const div = document.createElement('div');
                div.className = 'movie-card';
                div.innerHTML = `
                    <img src="${movie.Poster}" 
                         alt="${movie.Title}" 
                         class="movie-poster"
                         onerror="this.parentElement.style.display='none'">
                    <div class="movie-title">${movie.Title}</div>
                    <div class="movie-year">${movie.Year}</div>
                    <button class="like-btn"
                            style="width: 100%; margin-top: 10px; padding: 8px; cursor: pointer; background: ${isLiked ? '#ef4444' : '#667eea'}; color: white; border: none; border-radius: 5px; font-weight: bold;">
                        ${isLiked ? '‚ù§Ô∏è Lik√©' : 'ü§ç Liker'}
                    </button>
                `;

                const button = div.querySelector('.like-btn');
                button.addEventListener('click', () => {
                    toggleLike(movie.imdbID, movie.Title, movie.Poster, movie.Year);
                });

                container.appendChild(div);
            });
        }

        function displayLikedMovies() {
            const container = document.getElementById('movies');
            container.innerHTML = '';

            if (likedMovies.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #e0e0e0; padding: 40px; font-size: 1.2em;">Aucun film lik√© pour le moment</div>';
                return;
            }

            likedMovies.forEach(movie => {
                const div = document.createElement('div');
                div.className = 'movie-card';
                div.innerHTML = `
                    <img src="${movie.movie_poster}" 
                         alt="${movie.movie_title}" 
                         class="movie-poster"
                         onerror="this.parentElement.style.display='none'">
                    <div class="movie-title">${movie.movie_title}</div>
                    <div class="movie-year">${movie.movie_year}</div>
                    <button class="like-btn"
                            style="width: 100%; margin-top: 10px; padding: 8px; cursor: pointer; background: #ef4444; color: white; border: none; border-radius: 5px; font-weight: bold;">
                        ‚ù§Ô∏è Lik√©
                    </button>
                `;

                const button = div.querySelector('.like-btn');
                button.addEventListener('click', () => {
                    toggleLike(movie.movie_id, movie.movie_title, movie.movie_poster, movie.movie_year);
                });

                container.appendChild(div);
            });
        }

        function showAllMovies() {
            currentView = 'all';
            document.getElementById('allMoviesTab').style.background = '#667eea';
            document.getElementById('likedMoviesTab').style.background = '#2a2a2a';
            document.getElementById('searchForm').style.display = 'block';
            displayMovies(allMovies);
        }

        function showLikedMovies() {
            currentView = 'liked';
            document.getElementById('allMoviesTab').style.background = '#2a2a2a';
            document.getElementById('likedMoviesTab').style.background = '#667eea';
            document.getElementById('searchForm').style.display = 'none';
            displayLikedMovies();
        }

        document.getElementById('searchForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const searchValue = document.getElementById('search').value;

            if (searchValue.trim() === '') {
                displayMovies(allMovies);
            } else {
                const filtered = allMovies.filter(movie =>
                    movie.Title.toLowerCase().includes(searchValue.toLowerCase())
                );
                displayMovies(filtered);
            }
        });

        // Charger les films et les likes
        async function init() {
            const moviesResponse = await fetch('/api/movies');
            const movies = await moviesResponse.json();
            allMovies = movies;

            const likesResponse = await fetch(`/api/likes/${user.id}`);
            const likesData = await likesResponse.json();
            if (likesData.success) {
                likedMovies = likesData.likes;
            }

            displayMovies(allMovies);
        }

        init();
    </script>
</body>

</html>